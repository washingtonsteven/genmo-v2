# ðŸ“• Genmo v2 ðŸ“—

## New, updated, sleeker, sexier, adjectivier, and cheesier than ever! ðŸ§€

Genmo is a text narrative engine that is meant to be pluggable into any sort of frontend. 

---

## Table of Contents

  * [Generating Stories](#generating-stories)
  * [Usage](#usage)
    * [Options](#options)
        * [outputFunction](#outputfunction)
        * [errorFunction](#errorfunction)
  * [API](#api)
    * [new Genmo(storyData, options = {})](#new-genmostorydata-options--)
    * [outputCurrentPassage()](#outputcurrentpassage)
    * [followLink(Object|String)](#followlinkobjectstring)
    * [state](#state)

---

### Generating Stories

Stories are in JSON format, as written in [Twine](http://twinery.org/) using the [Twison](https://github.com/lazerwalker/twison) story format. Create your story in Twine as usual, then use the Twison story format to export your story to a `.json` file.

Currently, no Harlowe functions are available (unless you implement them in your `outputFunction`, [see below](#outputFunction)). Any directives will be output in the JSON with zero processing.

If you do not want your links to show up in the body text, you can separate them with a newline, 3 dashes, and another newline:

```
Normal passage text.

---

[[Page 2]]
[[Page 3]]
```

This will generate a `passageText` variable on each passage that only has the text above that divider.

#### Story Data

You can update story data upon entering a passage by including a JSON object describing the data you want to change under the links with a similar separator for the link

```
Normal passage text.

---

[[Page 2]]
[[Page 3]]

---
{
  "hp":10,
  "wizard_staff": true,
  "player_name": "Steve"
}

```

Data is cumulative, so you don't need to specify the entire data object in each passage. You can use `++` or `--` prefixes to increment/decrement a variable by a value:

```
The orc hits you for 2 damage!

---

[[Fight back]]

---

{
  "hp":"--2"
}
```

After the last two example blocks, `hp` will be set to `8`

#### Conditional Links

You can use named links (using `->`) in order to specify conditions for the link to appear, separated from the name with `||`:

```
Normal passage text

---

[[Go home]]
[[Go to the hospital||hp lt 10->Go to the hospital]]
```

This will only display `Go to the hospital` if the variable `hp` is less than `10`

The operators available are: 
  - `lt`: less than
  - `gt`: greater than
  - `lte`: less than or equal
  - `gte`: greater than or equal
  - `eq`: equals
  - `seq`: strict equals (`===`)

`lt`, `gt`, `lte`, and `gte` will convert any variable to a Number before comparison.

The displayed name will also have anything after `||` removed before display/`outputFunction`

### Usage

```js
import { Genmo } from "genmo-v2";

// Load in your JSON however you like
import StoryJSON from "story.json";

const story = new Genmo(StoryJSON, {
  outputFunction: (passage) => {
    // output passage
  },
  errorFunction: (err) => {
    // deal with error
  }
})
```

Note that `Genmo` is not a default export, but a named one. In CommonJS:

```js
const Genmo = require("genmo-v2").Genmo
```

#### Options

##### `outputFunction`

```js
const outputFunction = (passage) => {

}
```

You will receive the entire "passage" object from the StoryJSON generated by Twine:

  - `text` : Main passage text (including links and unprocessed Harlowe directives)
  - `links`: Array of links in this passage
    - `name`: The display text for this link
    - `link`: The name of the passage this link links to
    - `pid`: The Passage Id of the passage this link links to
  - `name`: The name of this passage
  - `pid`: The Passage Id of this passage
  - `position`: The position of this passage within Twine
    - `x`: x position of the passage. String.
    - `y`: y position of the passage. String.

In addition you will recieve `passageText` (`passage.passageText`) which is a subset of the text above the link divider (see [Generating Stories](#generating-stories) above)

Returning any value from the `outputFunction` will also return that value from functions that "output" (i.e. `Genmo.outputCurrentPassage`)

##### `errorFunction`

```js
const errorFunction = (err) => {

}
```

This will be called if you do anything illegal with Genmo (except call its constructor without storyData, in which case an `Error` will be thrown).

If your `errorFunction` returns a value, any function that calls your `errorFunction` will also return that value.

Possible errors are available as an export named `ERRORS`

```js
import { ERRORS } from "genmo-v2";
```

### API

#### `new Genmo(storyData, options = {})`

Constructs a new Genmo Object. Options are detailed above.

#### `outputCurrentPassage()`

```
story.outputCurrentPassage()
```

This function will call your `outputFunction` with the current passage.
If your `outputFunction` returns a value, it will be returned here as well.

#### `followLink(Object|String)`

```
story.followLink(link)
```

This will set the `currentPassage` to the passage linked to in the provided `link`. This will only work if the link you are trying to follow is on the `currentPassage`. You may pass in the entire object from the `links` array in the passage, or just the `pid` of the passage that link goes to.

Attempting to follow an invalid link (the link doesn't exist, is not a part of this passage, or does not link to a passage that exists, etc.) will call your `errorFunction` and return any value you had set there.

#### `state`

```
story.state

story.state.storyData

story.state.currentPassage
```

Genmo keeps track of its state in `state`, there are several properties:

- `storyData`: The complete storyData passed in the Genmo constructor
  - `passages`: Array of passage objects
  - `name`: Name of the Story (as set in Twine)
  - `startnode`: The `pid` of the starting passage
  - `creator`: The name of the app that created the story (usually "Twine")
  - `creator-version`: Version of Twine when this story was made
  - `ifid`: String representing an ID to be used in the [Interactive Fiction Database](https://ifdb.tads.org/help-ifid)
- `currentPassage`: The current passage set. Passage properties are detailed in the [`outputFunction` section](#outputFunction) above

**As a general rule:** `state` should only be read from, not written to. Writing to state outside of the provided functions (`followLink()`, etc) may cause inconsistent behavior. 